name: Deploy Spring Boot to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clone source code t·ª´ GitHub
      - name: 1Ô∏è‚É£ Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Thi·∫øt l·∫≠p JDK 21
      - name: 2Ô∏è‚É£ Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3Ô∏è‚É£ C√†i ƒë·∫∑t Maven
      - name: 3Ô∏è‚É£ Install Maven
        run: sudo apt-get install -y maven

      # 4Ô∏è‚É£ X√≥a th∆∞ m·ª•c c≈© & Ki·ªÉm tra l·∫°i source code
      - name: 4Ô∏è‚É£ Clean old builds
        run: |
          rm -rf target
          ls -la

      # 5Ô∏è‚É£ Build Spring Boot Application
      - name: 5Ô∏è‚É£ Build Spring Boot Application
        run: |
          chmod +x mvnw || true
          ./mvnw clean package -DskipTests || mvn clean package -DskipTests

      # 6Ô∏è‚É£ Ki·ªÉm tra l·∫°i file JAR
      - name: 6Ô∏è‚É£ Verify JAR file exists
        run: |
          ls -la target/
          JAR_FILE=$(ls target/*.jar | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y file JAR trong th∆∞ m·ª•c target/"
            exit 1
          fi
          echo "‚úÖ T√¨m th·∫•y file JAR: $JAR_FILE"

      # 7Ô∏è‚É£ Build Docker Image
      - name: üèó Build Docker Image
        run: |
          mv target/*.jar target/myapp.jar
          docker build -t myapp:latest .
          docker save myapp:latest -o myapp.tar
          sudo chmod 644 myapp.tar  # ƒê·∫£m b·∫£o quy·ªÅn truy c·∫≠p

      # 8Ô∏è‚É£ Ki·ªÉm tra file Docker Image tar
      - name: ‚úÖ Verify Docker image tar file
        run: |
          ls -la
          if [ ! -f myapp.tar ]; then
            echo "‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y myapp.tar"
            exit 1
          fi

      # 9Ô∏è‚É£ Copy Docker Image l√™n VPS
      - name: üì¶ Copy image to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "myapp.tar"
          target: "/home/user/app/"

      # üîü Deploy tr√™n VPS m√† kh√¥ng b·ªã tr√πng port
      - name: üöÄ Load Docker Image & Restart Container
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            sudo systemctl start docker || sudo service docker start
            cd /home/user/app
            docker load -i myapp.tar
            docker stop spring_boot || true
            docker rm spring_boot || true
            docker run -d --name spring_boot -p 8080:8080 --restart always myapp:latest

      # üîî G·ª≠i th√¥ng b√°o l√™n Discord khi deploy th√†nh c√¥ng
      - name: üîî Notify Discord for success
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d '{"content": "üöÄ Deploy Spring Boot th√†nh c√¥ng l√™n VPS!"}' \
            "$WEBHOOK"
          fi

  # N·∫øu c√≥ l·ªói, g·ª≠i th√¥ng b√°o l√™n Discord
#  failure:
#    runs-on: ubuntu-latest
#    steps:
#      - name: ‚ö†Ô∏è Notify Discord for failure
#        env:
#          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
#        run: |
#          if [ -n "$WEBHOOK" ]; then
#            curl -X POST -H "Content-Type: application/json" \
#            -d '{"content": "‚ö†Ô∏è Deploy Spring Boot th·∫•t b·∫°i!"}' \
#            "$WEBHOOK"
#          fi
