name: Deploy Spring Boot to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”” Notify Discord for start deploy
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d '{"content": "ğŸš€  Báº¯t Ä‘áº§u Deploy Spring Boot lÃªn VPS!"}' \
            "$WEBHOOK"
          fi
      # 1ï¸âƒ£ Clone source code tá»« GitHub
      - name: 1ï¸âƒ£ Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Thiáº¿t láº­p JDK 21
      - name: 2ï¸âƒ£ Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3ï¸âƒ£ CÃ i Ä‘áº·t Maven
      - name: 3ï¸âƒ£ Install Maven
        run: sudo apt-get install -y maven

      # 4ï¸âƒ£ XÃ³a thÆ° má»¥c cÅ© & Kiá»ƒm tra láº¡i source code
      - name: 4ï¸âƒ£ Clean old builds
        run: |
          rm -rf target
          ls -la

      # 5ï¸âƒ£ Build Spring Boot Application
      - name: 5ï¸âƒ£ Build Spring Boot Application
        run: |
          chmod +x mvnw || true
          ./mvnw clean package -DskipTests || mvn clean package -DskipTests

      # 6ï¸âƒ£ Kiá»ƒm tra láº¡i file JAR
      - name: 6ï¸âƒ£ Verify JAR file exists
        run: |
          ls -la target/
          JAR_FILE=$(ls target/*.jar | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y file JAR trong thÆ° má»¥c target/"
            exit 1
          fi
          echo "âœ… TÃ¬m tháº¥y file JAR: $JAR_FILE"

      # 7ï¸âƒ£ Build Docker Image
      - name: ğŸ— Build Docker Image
        run: |
          mv target/*.jar target/myapp.jar
          docker build -t myapp:latest .
          docker save myapp:latest -o myapp.tar
          sudo chmod 644 myapp.tar  # Äáº£m báº£o quyá»n truy cáº­p

      # 8ï¸âƒ£ Kiá»ƒm tra file Docker Image tar
      - name: âœ… Verify Docker image tar file
        run: |
          ls -la
          if [ ! -f myapp.tar ]; then
            echo "âŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y myapp.tar"
            exit 1
          fi

      # 9ï¸âƒ£ Copy Docker Image lÃªn VPS
      - name: ğŸ“¦ Copy image to VPS
        env:
          VPS_IP: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          echo "${VPS_SSH_KEY}" > ssh_key
          chmod 600 ssh_key
          scp -o StrictHostKeyChecking=no -i ssh_key myapp.tar ${VPS_USER}@${VPS_IP}:/home/user/app/

      # ğŸ”Ÿ Deploy trÃªn VPS mÃ  khÃ´ng bá»‹ trÃ¹ng port
      - name: ğŸš€ Load Docker Image & Restart Container
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            sudo systemctl start docker || sudo service docker start
            cd /home/user/app
            docker load -i myapp.tar
            docker stop spring_boot || true
            docker rm spring_boot || true
            docker run -d --name spring_boot -p 8080:8080 --restart always myapp:latest

      # ğŸ”” Gá»­i thÃ´ng bÃ¡o lÃªn Discord khi deploy thÃ nh cÃ´ng
      - name: ğŸ”” Notify Discord for success
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK" ]; then
            curl -X POST -H "Content-Type: application/json" \
            -d '{"content": "ğŸš€ Deploy Spring Boot thÃ nh cÃ´ng lÃªn VPS!"}' \
            "$WEBHOOK"
          fi

  # Náº¿u cÃ³ lá»—i, gá»­i thÃ´ng bÃ¡o lÃªn Discord
#  failure:
#    runs-on: ubuntu-latest
#    steps:
#      - name: âš ï¸ Notify Discord for failure
#        env:
#          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
#        run: |
#          if [ -n "$WEBHOOK" ]; then
#            curl -X POST -H "Content-Type: application/json" \
#            -d '{"content": "âš ï¸ Deploy Spring Boot tháº¥t báº¡i!"}' \
#            "$WEBHOOK"
#          fi
